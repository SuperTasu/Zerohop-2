<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- ★★★ iPad/iOS用設定 ★★★ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="バス掲示板">
    <meta name="format-detection" content="telephone=no">

    <title>バス電光掲示板 (iPad Offline)</title>
    <style>
        body {
            /* iPadシステムフォントを優先 */
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 10px;
            /* ノッチ対策（セーフエリア） */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            overflow-x: hidden;
            font-size: 16px; /* 文字サイズを少し大きく */
            -webkit-text-size-adjust: 100%;
        }

        /* ボタンのタッチ反応を良くする */
        button, input, label {
            touch-action: manipulation;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                padding-top: env(safe-area-inset-top); /* スマホでもノッチ考慮 */
            }
        }

        .display-board {
            background-color: #fff;
            border: 3px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 100%;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .direction-controls {
            display: flex;
            gap: 10px;
            width: 100%; /* iPadでは横幅いっぱいに */
        }

        .direction-button {
            flex: 1; /* ボタンを均等配置 */
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            padding: 12px 10px; /* タップしやすい大きさ */
            margin: 0;
            font-size: 15px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent; /* タップ時のハイライト削除 */
        }
        
        .direction-button.active {
            background-color: #0066cc;
            color: white;
            border-color: #0066cc;
            box-shadow: 0 2px 5px rgba(0,102,204,0.3);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: flex-end;
            width: 100%;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
            background: #eee;
            padding: 8px;
            border-radius: 8px;
        }

        .current-time {
            font-size: 20px;
            color: #0066cc;
            font-weight: bold;
            font-family: "Menlo", "Courier New", monospace; /* 等幅フォント */
        }

        .schedule-type {
            font-size: 14px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: #fff;
        }

        /* --- PC・スマホ(iPad縦含む) レイアウト切り替え --- */
        .pc-container { display: none; }
        .mobile-container { display: block; }

        /* iPad横向き以上で2カラム表示 */
        @media (min-width: 820px) {
            .mobile-container { display: none; }
            .pc-container {
                display: flex;
                align-items: stretch;
                background-color: #f0fff0;
                border: 3px solid #2e8b57;
                border-radius: 10px;
                padding: 15px;
                min-height: 500px; /* 高さを確保 */
            }
            .left-column {
                flex: 1;
                display: flex;
                flex-direction: column;
                margin-right: 15px;
                position: relative;
            }
            .right-column {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            #pcFirstDepartureDetail, #pcOverlayDetail {
                height: 100%;
                border-radius: 8px;
                overflow: hidden;
            }
            #pcNextDepartureInfo .next-departure-content {
                background: white;
                padding: 15px;
                border: 2px solid #009900;
                border-radius: 8px;
                margin-bottom: 10px;
            }
            #pcDepartureList {
                background: white;
                border-radius: 8px;
                padding: 10px;
                flex-grow: 1;
                overflow-y: auto;
            }
        }

        /* iPad縦・スマホ用 */
        .next-departure {
            background-color: #e8f5e8;
            border: 3px solid #009900;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .next-departure-title {
            font-size: 18px;
            font-weight: bold;
            color: #009900;
            margin-bottom: 10px;
        }

        .next-departure-content {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #009900;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .next-departure-route { font-size: 16px; font-weight: bold; text-align: left; }
        .next-departure-time { 
            display: flex; 
            justify-content: center; 
            align-items: baseline; 
            gap: 10px; 
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }
        .next-departure-clock { font-size: 32px; color: #cc0000; font-family: "Menlo", monospace; }
        .next-departure-remaining { font-size: 24px; color: #009900; font-weight: bold; }

        /* リスト表示 */
        .departure-info {
            background: white;
            border: 1px solid #ddd;
            border-left: 5px solid #0066cc;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        
        .departure-time-row {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            margin-top: 5px;
        }
        .departure-time-main { font-size: 20px; color: #cc0000; font-weight: bold; font-family: "Menlo", monospace;}
        .departure-time-rem { font-size: 16px; color: #009900; }

        .detail-button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            margin-left: auto;
        }

        /* オフライン表示用 */
        .network-status-bar {
            display: none;
            background-color: #cc0000;
            color: white;
            text-align: center;
            font-size: 14px;
            padding: 8px;
            position: fixed;
            top: 0; left: 0; width: 100%;
            z-index: 9999;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .network-status-bar.visible { display: block; }

        .departure-detail-embedded.offline-placeholder {
            background-color: #f0f0f0;
            border: 2px dashed #ccc;
            color: #666;
            padding: 30px 10px;
            text-align: center;
            border-radius: 8px;
            margin-top: 10px;
        }
        .departure-detail-embedded iframe {
            width: 100%;
            height: 300px;
            border: none;
            border-radius: 8px;
        }

        /* 設定パネル */
        .operation-panel { position: relative; }
        .operation-panel-content {
            display: none;
            position: absolute;
            top: 120%; right: 0;
            width: 300px;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 15px;
            z-index: 100;
        }
        .operation-panel-content.expanded { display: block; }
        .operation-panel-header {
            background: white; border: 1px solid #0066cc; color: #0066cc;
            padding: 8px 12px; border-radius: 6px; font-weight: bold;
        }

        .show-departures-btn {
            width: 100%;
            padding: 15px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
        }

        /* モーダル */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 2000;
            justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }
        .modal-overlay.visible { display: flex; }
        .modal-content {
            background: white; width: 100%; max-width: 600px;
            max-height: 80vh; overflow-y: auto;
            border-radius: 12px; padding: 20px;
            -webkit-overflow-scrolling: touch; /* スクロール慣性 */
        }
        .close-modal {
            float: right; font-size: 28px; line-height: 28px; color: #999;
        }
    </style>
</head>
<body>
    <div id="networkStatusBar" class="network-status-bar">⚠️ オフライン: 地図・詳細は表示されません</div>

    <div class="display-board">
        <div class="header-container">
            <div class="time-info">
                <div class="current-time" id="currentTime">--:--:--</div>
                <div class="schedule-type" id="scheduleType">--</div>
            </div>
            
            <div class="direction-controls">
                <button id="shinkaichi-btn" class="direction-button">神戸駅・大学病院</button>
                <button id="yoshidacho-btn" class="direction-button active">板宿・新長田</button>
            </div>
            
            <div class="header-controls">
                <div class="operation-panel" id="operationPanel">
                    <div class="operation-panel-header" id="operationPanelHeader">
                        設定 ▼
                    </div>
                    <div class="operation-panel-content" id="operationPanelContent">
                        <div style="font-weight:bold; margin-bottom:10px;">表示系統</div>
                        <div class="route-checkboxes" id="routeCheckhouses" style="display:grid; gap:10px; margin-bottom:15px;"></div>
                        <div style="display:flex; gap:5px; justify-content:center;">
                            <button id="selectAllBtn" style="padding:5px 10px;">全選択</button>
                            <button id="clearAllBtn" style="padding:5px 10px;">全解除</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PC/iPad横 Layout -->
        <div class="pc-container">
            <div class="left-column">
                <div id="pcFirstDepartureDetail"></div>
            </div>
            <div class="right-column">
                <div id="pcNextDepartureInfo"></div>
                <div id="pcDepartureList"></div>
            </div>
        </div>

        <!-- Mobile/iPad縦 Layout -->
        <div class="mobile-container">
            <div class="next-departure">
                <div class="next-departure-title">次のバス (鷹取団地前)</div>
                <div id="justDepartedSection"></div>
                <div id="mobileNextDepartureContent"></div>
            </div>
            
            <button id="showDeparturesBtn" class="show-departures-btn">出発予定一覧を表示</button>
            <!-- 隠しリスト -->
            <div id="departureList" style="display:none;"></div>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <span id="closeModal" class="close-modal">&times;</span>
                <div style="font-size:18px; font-weight:bold;">出発予定一覧</div>
            </div>
            <div id="modalDepartureList"></div>
        </div>
    </div>

<script>
    // 時刻表データ
    const timetables = {
        shinkaichi: {
            route11: {
                name: "神戸駅前方面",
                number: "11",
                detailUrl: "https://location.its-mo.com/usersite/kobe/US0005/search/jp?busStopCode=0440&directionId=kobe0016",
                weekdays: [{h:6,m:[12,27,42]},{h:7,m:[7,24,38,52,59]},{h:8,m:[11,21,32,44,51]},{h:9,m:[5,13,37,49]},{h:10,m:[25,50]},{h:11,m:[1,25]},{h:12,m:[2,25]},{h:13,m:[2,25]},{h:14,m:[2,25]},{h:15,m:[2,25]},{h:16,m:[2,25]},{h:17,m:[2,25]},{h:18,m:[2,25,49]},{h:19,m:[1,25,50]},{h:20,m:[19,49]},{h:21,m:[29,49]},{h:22,m:[7,25,39,53]}],
                holidays: [{h:6,m:[12,27,42,55]},{h:7,m:[17,37,57]},{h:8,m:[17,37,57]},{h:9,m:[19,55]},{h:10,m:[19,31,55]},{h:11,m:[19,31,55]},{h:12,m:[19,31,55]},{h:13,m:[19,31,55]},{h:14,m:[19,31,55]},{h:15,m:[19,31,55]},{h:16,m:[19,31,55]},{h:17,m:[19,31,55]},{h:18,m:[19,31,55]},{h:19,m:[31,55]},{h:20,m:[37]},{h:21,m:[12,52]},{h:22,m:[12,32,53]}]
            },
            route13: {
                name: "地下鉄長田駅 経由 兵庫駅方面",
                number: "13",
                detailUrl: "https://location.its-mo.com/usersite/kobe/US0005/search/jp?busStopCode=0440&directionId=kobe0017",
                weekdays: [{h:8,m:[54]},{h:10,m:[7,56]},{h:11,m:[47]},{h:12,m:[37]},{h:13,m:[27]},{h:14,m:[15]},{h:15,m:[7,57]},{h:16,m:[42]},{h:17,m:[22]},{h:18,m:[2,42]}],
                holidays: [{h:7,m:[7,27,47]},{h:8,m:[7,27,47]},{h:9,m:[7,31,43]},{h:10,m:[7,43]},{h:11,m:[7,43]},{h:12,m:[7,43]},{h:13,m:[7,43]},{h:14,m:[7,43]},{h:15,m:[7,43]},{h:16,m:[7,43]},{h:17,m:[7,43]},{h:18,m:[7,43]},{h:19,m:[7,19,43]},{h:20,m:[7,52]},{h:21,m:[32]}]
            },
            route110: {
                name: "大学病院 経由 神戸駅方面",
                number: "110",
                detailUrl: "https://location.its-mo.com/usersite/kobe/US0005/search/jp?busStopCode=0440&directionId=kobe0122",
                weekdays: [{h:6,m:[55]},{h:7,m:[17,31,45]},{h:8,m:[5,16,26,38,57]},{h:9,m:[1,13,37]},{h:10,m:[13,37,49]},{h:11,m:[13,37,49]},{h:12,m:[13,37,49]},{h:13,m:[13,37,49]},{h:14,m:[13,37,49]},{h:15,m:[13,37,49]},{h:16,m:[13,37,49]},{h:17,m:[13,37,49]},{h:18,m:[13,38]},{h:19,m:[13,37]},{h:20,m:[5,34]},{h:21,m:[9]}],
                holidays: [{h:7,m:[7,27,47]},{h:8,m:[7,27,47]},{h:9,m:[7,31,43]},{h:10,m:[7,43]},{h:11,m:[7,43]},{h:12,m:[7,43]},{h:13,m:[7,43]},{h:14,m:[7,43]},{h:15,m:[7,43]},{h:16,m:[7,43]},{h:17,m:[7,43]},{h:18,m:[7,43]},{h:19,m:[7,19,43]},{h:20,m:[7,52]},{h:21,m:[32]}]
            }
        },
        yoshidacho: {
            route11A: {
                name: "板宿止まり",
                number: "11A",
                detailUrl: "https://location.its-mo.com/usersite/kobe/US0005/search/jp?busStopCode=0440&directionId=kobe0015",
                weekdays: [{h:6,m:[21,31,53]},{h:7,m:[14,35,53]},{h:8,m:[12,29,48]},{h:9,m:[13]},{h:10,m:[9,33]},{h:11,m:[21]},{h:12,m:[22]},{h:13,m:[25]},{h:14,m:[25]},{h:15,m:[25]},{h:16,m:[25]},{h:17,m:[26,58]},{h:18,m:[38]},{h:19,m:[8,41]},{h:20,m:[5,39]},{h:21,m:[15,45]},{h:22,m:[0,30,45]},{h:23,m:[5]}],
                holidays: [{h:6,m:[21]},{h:7,m:[9,21,46]},{h:8,m:[11,35]},{h:9,m:[12]},{h:10,m:[0,24]},{h:11,m:[0,24]},{h:12,m:[1,25]},{h:13,m:[1,25]},{h:14,m:[1,25]},{h:15,m:[1,25]},{h:16,m:[1,25,47]},{h:17,m:[8,28,48]},{h:18,m:[8]},{h:19,m:[7,41,53]},{h:20,m:[15,51]},{h:21,m:[15,39,54]},{h:22,m:[24,44]}]
            },
            route13: {
                name: "板宿 経由 新長田駅前方面",
                number: "13",
                detailUrl: "https://location.its-mo.com/usersite/kobe/US0005/search/jp?busStopCode=0440&directionId=kobe0017",
                weekdays: [{h:8,m:[13]},{h:9,m:[26]},{h:10,m:[15]},{h:11,m:[7,57]},{h:12,m:[47]},{h:13,m:[35]},{h:14,m:[27]},{h:15,m:[17]},{h:16,m:[2,41]},{h:17,m:[21]},{h:18,m:[1]}],
                holidays: [{h:8,m:[13]},{h:9,m:[26]},{h:10,m:[15]},{h:11,m:[7,57]},{h:12,m:[47]},{h:13,m:[35]},{h:14,m:[27]},{h:15,m:[17]},{h:16,m:[2,41]},{h:17,m:[21]},{h:18,m:[1]}]
            },
            route110A: {
                name: "板宿止まり",
                number: "110A",
                detailUrl: "https://location.its-mo.com/usersite/kobe/US0005/search/jp?busStopCode=0440&directionId=kobe0122",
                weekdays: [{h:6,m:[41]},{h:7,m:[3,26,46]},{h:8,m:[7,25,43]},{h:9,m:[8,36]},{h:10,m:[24]},{h:11,m:[12,36]},{h:12,m:[12,39]},{h:13,m:[15,39]},{h:14,m:[16,39]},{h:15,m:[15,39]},{h:16,m:[15,39]},{h:17,m:[15,40]},{h:18,m:[20,50]},{h:19,m:[20]},{h:20,m:[16,52]},{h:21,m:[31]},{h:22,m:[16]},{h:23,m:[26]}],
                holidays: [{h:7,m:[36]},{h:8,m:[0]},{h:9,m:[3]},{h:10,m:[15]},{h:11,m:[15]},{h:12,m:[15]},{h:13,m:[15]},{h:14,m:[15]},{h:15,m:[15]},{h:16,m:[15]},{h:17,m:[19]},{h:18,m:[20]},{h:19,m:[20]},{h:20,m:[40]},{h:21,m:[28]},{h:22,m:[11]},{h:23,m:[6]}]
            },
            route112: {
                name: "五位ノ池 経由 鷹取駅方面",
                number: "112",
                detailUrl: "https://location.its-mo.com/usersite/kobe/US0005/search/jp?busStopCode=0440&directionId=kobe0126",
                weekdays: [{h:10,m:[47]},{h:11,m:[48]},{h:12,m:[51]},{h:13,m:[51]},{h:14,m:[51]},{h:15,m:[51]},{h:16,m:[51]},{h:17,m:[50]}],
                holidays: [{h:8,m:[48]},{h:9,m:[51]},{h:10,m:[51]},{h:11,m:[51]},{h:12,m:[51]},{h:13,m:[51]},{h:14,m:[51]},{h:15,m:[51]},{h:16,m:[59]},{h:18,m:[40]},{h:19,m:[28]},{h:20,m:[28]},{h:21,m:[11]},{h:22,m:[6]}]
            }
        }
    };

    // 状態管理
    let currentDirection = 'yoshidacho';
    let selectedRoutes = new Set();
    const LS_KEY_DIRECTION = 'ipadBus_dir';
    const LS_KEY_ROUTES = 'ipadBus_routes';

    // 共通関数
    function isOnline() { return navigator.onLine; }
    function isHoliday(d) {
        const day = d.getDay();
        const m = d.getMonth()+1; const da = d.getDate(); const y = d.getFullYear();
        if(y===2025 && m===8 && da===15) return true;
        return day===0 || day===6;
    }

    // ネットワーク状態バー
    function updateNetworkStatus() {
        const bar = document.getElementById('networkStatusBar');
        if(isOnline()) bar.classList.remove('visible');
        else bar.classList.add('visible');
    }

    // 設定保存・読込 (iPadのファイルアプリでは保持されない場合もあります)
    function saveSettings() {
        try {
            localStorage.setItem(LS_KEY_DIRECTION, currentDirection);
            localStorage.setItem(LS_KEY_ROUTES, JSON.stringify(Array.from(selectedRoutes)));
        } catch(e) {}
    }
    function loadSettings() {
        try {
            const d = localStorage.getItem(LS_KEY_DIRECTION);
            if(d && timetables[d]) currentDirection = d;
            
            const r = localStorage.getItem(LS_KEY_ROUTES);
            if(r) selectedRoutes = new Set(JSON.parse(r));
        } catch(e) {}
        
        // ボタン状態同期
        document.getElementById('shinkaichi-btn').classList.toggle('active', currentDirection === 'shinkaichi');
        document.getElementById('yoshidacho-btn').classList.toggle('active', currentDirection === 'yoshidacho');
    }

    // データ処理
    function getAllDepartures() {
        const now = new Date();
        const fiveMinAgo = new Date(now.getTime() - 5*60000);
        const list = [];
        const t = timetables[currentDirection];
        const targets = selectedRoutes.size > 0 ? Array.from(selectedRoutes) : Object.keys(t);
        
        // 今日と明日の分を計算（深夜対応のため）
        [0, 1].forEach(offset => {
            const targetDate = new Date(now);
            targetDate.setDate(targetDate.getDate() + offset);
            const type = isHoliday(targetDate) ? 'holidays' : 'weekdays';
            
            targets.forEach(key => {
                const route = t[key];
                if(!route || !route[type]) return;
                route[type].forEach(hData => {
                    hData.m.forEach(min => {
                        const d = new Date(targetDate);
                        d.setHours(hData.h, min, 0, 0);
                        if(d >= fiveMinAgo) {
                            list.push({ ...route, date: d });
                        }
                    });
                });
            });
        });
        
        return list.sort((a,b) => a.date - b.date);
    }

    // 表示更新
    function updateDisplay() {
        updateNetworkStatus();
        const now = new Date();
        
        // 時計
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('ja-JP');
        const stEl = document.getElementById('scheduleType');
        if(isHoliday(now)) { stEl.textContent = '休日ダイヤ'; stEl.style.color='#cc0000'; }
        else { stEl.textContent = '平日ダイヤ'; stEl.style.color='#009900'; }

        const all = getAllDepartures();
        const upcoming = all.filter(d => d.date >= now);
        
        // 直近の出発（終了分）
        const justGone = all.filter(d => d.date < now);
        let goneHtml = '';
        if(justGone.length > 0) {
            justGone.forEach(d => {
                const timeStr = `${d.date.getHours()}:${String(d.date.getMinutes()).padStart(2,'0')}`;
                goneHtml += `<div style="font-size:12px; background:#ddd; padding:5px; margin-bottom:5px; border-radius:4px;">
                    <span style="border:1px solid #333; padding:0 3px;">${d.number}</span> ${d.name} (${timeStr}) は出発しました
                </div>`;
            });
        }
        document.getElementById('justDepartedSection').innerHTML = goneHtml;

        // 次のバス
        const mobileContent = document.getElementById('mobileNextDepartureContent');
        const pcNextInfo = document.getElementById('pcNextDepartureInfo');
        const pcFirstDetail = document.getElementById('pcFirstDepartureDetail');

        if(upcoming.length === 0) {
            const noMsg = `<div style="text-align:center; padding:20px; color:#c00;">運行終了</div>`;
            mobileContent.innerHTML = noMsg;
            pcNextInfo.innerHTML = noMsg;
            pcFirstDetail.innerHTML = "";
        } else {
            const next = upcoming[0];
            const diff = Math.ceil((next.date - now)/60000);
            const timeStr = `${String(next.date.getHours()).padStart(2,'0')}:${String(next.date.getMinutes()).padStart(2,'0')}`;
            const remStr = diff <= 0 ? "まもなく" : `あと${diff}分`;
            
            let arrivalHtml = "";
            if(currentDirection==='yoshidacho') {
                const arr = new Date(next.date.getTime() + 7*60000);
                arrivalHtml = `<div style="font-size:12px; color:#d60;">板宿 ${arr.getHours()}:${String(arr.getMinutes()).padStart(2,'0')}着</div>`;
            }

            // HTML生成
            const infoHtml = `
                <div class="next-departure-content">
                    <div class="next-departure-route">
                        <span style="border:2px solid #0066cc; color:#0066cc; padding:0 5px;">${next.number}</span> ${next.name}
                        ${arrivalHtml}
                    </div>
                    <div class="next-departure-time">
                        <div class="next-departure-clock">${timeStr}</div>
                        <div class="next-departure-remaining">(${remStr})</div>
                    </div>
                </div>`;
            
            // 地図埋め込み（オフライン判定）
            let mapHtml = "";
            if(next.detailUrl) {
                if(isOnline()) {
                    mapHtml = `<div class="departure-detail-embedded"><iframe src="${next.detailUrl}"></iframe></div>`;
                } else {
                    mapHtml = `<div class="departure-detail-embedded offline-placeholder"><div>⚠️ オフライン</div><small>地図は表示されません</small></div>`;
                }
            }

            mobileContent.innerHTML = infoHtml + mapHtml;
            pcNextInfo.innerHTML = infoHtml;
            pcFirstDetail.innerHTML = mapHtml; // PC左側用
        }

        // リスト生成
        const listContainer = document.getElementById('departureList'); // Mobile
        const pcListContainer = document.getElementById('pcDepartureList'); // PC
        const listData = upcoming.slice(1, 11); // 次の次から10件
        
        let listHtml = "";
        if(listData.length === 0) listHtml = "<div style='text-align:center; padding:10px;'>以降の便はありません</div>";
        else {
            listData.forEach(d => {
                const diff = Math.ceil((d.date - now)/60000);
                const timeStr = `${String(d.date.getHours()).padStart(2,'0')}:${String(d.date.getMinutes()).padStart(2,'0')}`;
                listHtml += `
                <div class="departure-info">
                    <div style="flex:1;">
                        <div><span style="border:1px solid #0066cc; color:#0066cc; font-size:12px; padding:0 3px;">${d.number}</span> ${d.name}</div>
                        <div class="departure-time-row">
                            <span class="departure-time-main">${timeStr}</span>
                            <span class="departure-time-rem">(あと${diff}分)</span>
                        </div>
                    </div>
                    ${d.detailUrl && isOnline() ? `<button class="detail-button" onclick="window.open('${d.detailUrl}')">詳細</button>` : ''}
                </div>`;
            });
        }
        
        listContainer.innerHTML = listHtml;
        pcListContainer.innerHTML = listHtml;
    }

    // 初期化とイベントリスナー
    document.addEventListener('DOMContentLoaded', () => {
        loadSettings();
        
        // 系統選択チェックボックス生成
        const cbContainer = document.getElementById('routeCheckhouses');
        const t = timetables[currentDirection];
        Object.keys(t).forEach(k => {
            const div = document.createElement('div');
            div.innerHTML = `<label style="display:flex; align-items:center; padding:5px;"><input type="checkbox" value="${k}" ${selectedRoutes.has(k)?'checked':''} style="transform:scale(1.3); margin-right:10px;"> ${t[k].number} ${t[k].name}</label>`;
            div.querySelector('input').addEventListener('change', (e) => {
                if(e.target.checked) selectedRoutes.add(k); else selectedRoutes.delete(k);
                saveSettings(); updateDisplay();
            });
            cbContainer.appendChild(div);
        });

        // ボタンイベント
        document.getElementById('shinkaichi-btn').onclick = () => {
            currentDirection='shinkaichi'; selectedRoutes.clear();
            saveSettings(); location.reload(); // 簡易リセット
        };
        document.getElementById('yoshidacho-btn').onclick = () => {
            currentDirection='yoshidacho'; selectedRoutes.clear();
            saveSettings(); location.reload();
        };

        // 設定パネル
        const panel = document.getElementById('operationPanelContent');
        document.getElementById('operationPanelHeader').onclick = () => panel.classList.toggle('expanded');
        document.getElementById('selectAllBtn').onclick = () => {
            document.querySelectorAll('#routeCheckhouses input').forEach(c => { c.checked=true; selectedRoutes.add(c.value); });
            saveSettings(); updateDisplay();
        };
        document.getElementById('clearAllBtn').onclick = () => {
            document.querySelectorAll('#routeCheckhouses input').forEach(c => { c.checked=false; });
            selectedRoutes.clear(); saveSettings(); updateDisplay();
        };

        // モーダル
        const modal = document.getElementById('modalOverlay');
        document.getElementById('showDeparturesBtn').onclick = () => {
            document.getElementById('modalDepartureList').innerHTML = document.getElementById('departureList').innerHTML;
            modal.classList.add('visible');
        };
        document.getElementById('closeModal').onclick = () => modal.classList.remove('visible');
        modal.onclick = (e) => { if(e.target===modal) modal.classList.remove('visible'); };

        // 更新ループ
        updateDisplay();
        setInterval(updateDisplay, 1000);
        window.addEventListener('online', updateDisplay);
        window.addEventListener('offline', updateDisplay);
    });
</script>
</body>
</html>
